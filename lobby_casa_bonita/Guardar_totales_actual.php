<?PHPinclude("datos.php");$Cobro=$_REQUEST['Cobro'];date_default_timezone_set('America/Bogota');$fecha_hoy=date("Y-m-d");$get_global_fecha_hoy="'".$fecha_hoy."'";$mysql=new mysqli($hostname_localhost,$username_localhost,$password_localhost,$database_localhost);if ($mysql->connect_error) die("Problemas con la conexiÃ³n a la base de datos");//CONSULTANDO NUMERO DE CLIENTES	$consultar_nclientes=$mysql->query("select count(*) from clientes where Cobro=$Cobro") or die ("problemas en consultar nclientes");    $get_nclientes=$consultar_nclientes->fetch_array();	     	$consultar_nclientes_prest=$mysql->query("select count(*) from creditos_casa_bonita") or die ("problemas en consultar nclientes");    $get_nclientes_prest=$consultar_nclientes_prest->fetch_array();    $nclientes_sinsaldo=$get_nclientes['count(*)']-$get_nclientes_prest['count(*)'];         $get_nclientes_comis=$get_nclientes['count(*)'];    $get_nclientes_prest_comis=$get_nclientes_prest['count(*)'];$consultar_total_actual=$mysql->query("SELECT sum(totalapagar), sum(tt_abonos), sum(tt_saldo)  FROM creditos_casa_bonita") or die ("problemas al consultar las cifras");if($get_datos=$consultar_total_actual->fetch_array()){$total_cuentas1=$get_datos['sum(totalapagar)'];$total_abonos1=$get_datos['sum(tt_abonos)'];$total_saldos1=$get_datos['sum(tt_saldo)'];	}$total_cuentas="'".$total_cuentas1."'";$total_abonos="'".$total_abonos1."'";$total_saldos="'".$total_saldos1."'";$consultar_cartera_enmora=$mysql->query("SELECT  sum(tt_saldo)  FROM `creditos_casa_bonita` where vencimiento < $get_global_fecha_hoy") or die("problemas al consultar cartera en mora");if($get_cartera_enmora=$consultar_cartera_enmora->fetch_array()){  $Total_cartera_mora=$get_cartera_enmora['sum(tt_saldo)'];  }      $Total_cartera_mora_comis="'".$Total_cartera_mora."'";$insertar_cifras=$mysql->query("INSERT INTO `totales`(`Mes`, `Total_cuentas`, `Total_abonos`, `Total_saldos`, `cartera_mora`, `tt_clientes`, `tt_prestamos`, `clientes_sinsaldo`,  `Cobro`) VALUES ($get_global_fecha_hoy, $total_cuentas,$total_abonos ,$total_saldos, $Total_cartera_mora_comis, $get_nclientes_comis,  $get_nclientes_prest_comis, $nclientes_sinsaldo, $Cobro)") or die ("problemas al insertar las cifras");if($insertar_cifras){		$consultar_nregistros=$mysql->query("SELECT COUNT(id) FROM totales where Cobro=$Cobro") or die("problemas al consultar total registros");	if($get_nREgistros=$consultar_nregistros->fetch_array()){		 $TotalRegistros=$get_nREgistros['COUNT(id)'];  		if($TotalRegistros>12){			$selectUltimo=$mysql->query("select min(Id) from totales where Cobro=$Cobro") or die("problemas al consultar ultimo id");			if($get_ultimoId=$selectUltimo->fetch_array()){				 $uId=$get_ultimoId['min(Id)']; 				}			$consultar_uregistros=$mysql->query("SELECT * FROM totales where Cobro=$Cobro and Id=$uId") or die("problemas al consultar ultimo registro");			if($get_ultimoR=$consultar_uregistros->fetch_array()){				 $Umes="'".$get_ultimoR['Mes']."'";				 $UTotal_cuentas="'".$get_ultimoR['Total_cuentas']."'";				 $UTotal_abonos="'".$get_ultimoR['Total_abonos']."'";				 $UTotal_saldos="'".$get_ultimoR['Total_saldos']."'";					 $UCartera_mora="'".$get_ultimoR['cartera_mora']."'";				 $UTt_clientes="'".$get_ultimoR['tt_clientes']."'";				 $UTt_prestamos="'".$get_ultimoR['tt_prestamos']."'";				 $UClientes_sinsaldo="'".$get_ultimoR['clientes_sinsaldo']."'";					 				}			 $guardarR=$mysql->query("INSERT INTO `Historial_totales`(`Mes`, `Total_cuentas`, `Total_abonos`, `Total_saldos`, `cartera_mora`, `tt_clientes`, `tt_prestamos`, `clientes_sinsaldo`,  `Cobro`) VALUES ($Umes, $UTotal_cuentas,$UTotal_abonos ,$UTotal_saldos, $UCartera_mora, $UTt_clientes,  $UTt_prestamos, $UClientes_sinsaldo, $Cobro)") or die ("problemas al insertar ultimo registro a historial totales");			if($guardarR){				$borrar_uid=$mysql->query("delete from totales where id=$uId") or die ("Problemas borrar primera fila");			}		}		}	header("Location: $url/Form_Cuadrar_cuentas.php");	}			?>